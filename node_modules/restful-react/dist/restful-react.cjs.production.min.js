"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var t=e(require("lodash/debounce")),r=e(require("lodash/isEqual")),n=require("qs"),o=e(n),s=require("react"),a=e(require("lodash/noop")),i=e(require("url")),u=e(require("lodash/merge")),l=e(require("react-fast-compare")),c=e(require("lodash/isEqualWith"));function p(){return(p=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}).apply(this,arguments)}function f(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e.__proto__=t}function h(e,t){try{var r=e()}catch(e){return t(e)}return r&&r.then?r.then(void 0,t):r}"undefined"!=typeof Symbol&&(Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator"))),"undefined"!=typeof Symbol&&(Symbol.asyncIterator||(Symbol.asyncIterator=Symbol("Symbol.asyncIterator")));var d=s.createContext({base:"",parentPath:"",resolve:function(e){return e},requestOptions:{},onError:a,queryParams:{}}),v=function(e){function t(){return e.apply(this,arguments)||this}return f(t,e),t.prototype.render=function(){var e=this.props,t=e.children,r=function(e,t){if(null==e)return{};var r,n,o={},s=Object.keys(e);for(n=0;n<s.length;n++)t.indexOf(r=s[n])>=0||(o[r]=e[r]);return o}(e,["children"]);return s.createElement(d.Provider,{value:p({onError:a,resolve:function(e){return e},requestOptions:{},parentPath:"",queryParams:r.queryParams||{}},r)},t)},t}(s.Component);v.displayName="RestfulProviderContext";var y=d.Consumer,m=function(e,t,r){void 0===e&&(e=""),void 0===t&&(t=""),void 0===r&&(r="");var n=g(t,r);return""===e&&n.startsWith("/")?n:e.endsWith("/")?""+e.slice(0,-1)+n:""+e+n},g=function(e,t){return void 0===e&&(e=""),void 0===t&&(t=""),t.startsWith("/")&&t.length>1?i.resolve(e,t):""!==t&&"/"!==t?e+"/"+t:e},b=function(e){try{return 204===e.status?Promise.resolve({data:void 0,responseError:!1}):(e.headers.get("content-type")||"").includes("application/json")?Promise.resolve(h((function(){return Promise.resolve(e.json()).then((function(e){return{data:e,responseError:!1}}))}),(function(e){return{data:e.message,responseError:!0}}))):Promise.resolve(e.text()).then((function(e){return{data:e,responseError:!1}}))}catch(e){return Promise.reject(e)}},P=function(e){function o(r){var o;return(o=e.call(this,r)||this).abortController=new AbortController,o.signal=o.abortController.signal,o.state={data:null,response:null,loading:!o.props.lazy,error:null},o.getRequestOptions=function(e,t){try{var r=function(r){return n?r:p({},e,{},s,{headers:new Headers(p({},"boolean"!=typeof t?t:{},{},(e||{}).headers,{},(s||{}).headers))})},n=!1,s=o.props.requestOptions,a=function(){if("function"==typeof s)return Promise.resolve(s()).then((function(r){return n=!0,p({},e,{},r,{headers:new Headers(p({},"boolean"!=typeof t?t:{},{},(e||{}).headers,{},r.headers))})}))}();return Promise.resolve(a&&a.then?a.then(r):r(a))}catch(e){return Promise.reject(e)}},o.fetch=function(e,t){try{var r=o.props,s=r.base,a=r.__internal_hasExplicitBase,i=r.parentPath,u=r.path,l=r.resolve;return!o.state.error&&o.state.loading||o.setState((function(){return{error:null,loading:!0}})),Promise.resolve(o.getRequestOptions(t)).then((function(r){var c=new Request(function(){var t;return t=a?m(s,"",u||""):m(s,i,e||u||""),Object.keys(o.props.queryParams).length&&(t+="?"+n.stringify(o.props.queryParams)),t}(),r);return h((function(){return Promise.resolve(fetch(c,{signal:o.signal})).then((function(r){return Promise.resolve(b(r)).then((function(n){var s=n.data,a=n.responseError;if(!o.signal.aborted){if(!r.ok||a){var i={message:"Failed to fetch: "+r.status+" "+r.statusText+(a?" - "+s:""),data:s,status:r.status};return o.setState({loading:!1,error:i}),!o.props.localErrorOnly&&o.props.onError&&o.props.onError(i,(function(){return o.fetch(e,t)}),r),null}return Promise.resolve(function(e){var t=e.data,r=e.resolve;try{var n=function(){return{data:o,error:s}},o=null,s=null,a=h((function(){var e=function(){if(r){var e=function(e){o=e},n=r(t);return n.then?Promise.resolve(n).then(e):e(n)}o=t}();if(e&&e.then)return e.then((function(){}))}),(function(e){o=null,s={message:"RESOLVE_ERROR",data:JSON.stringify(e)}}));return Promise.resolve(a&&a.then?a.then(n):n())}catch(e){return Promise.reject(e)}}({data:s,resolve:l})).then((function(e){return o.setState({loading:!1,data:e.data,error:e.error}),s}))}}))}))}),(function(e){o.signal.aborted||o.setState({loading:!1,error:{message:"Failed to fetch: "+e.message,data:e}})}))}))}catch(e){return Promise.reject(e)}},"object"==typeof r.debounce?o.fetch=t(o.fetch,r.debounce.wait,r.debounce.options):"number"==typeof r.debounce?o.fetch=t(o.fetch,r.debounce):r.debounce&&(o.fetch=t(o.fetch)),o}f(o,e);var a=o.prototype;return a.componentDidMount=function(){this.props.lazy||this.fetch()},a.componentDidUpdate=function(e){var t=e.resolve;(e.base!==this.props.base||e.parentPath!==this.props.parentPath||e.path!==this.props.path||!r(e.queryParams,this.props.queryParams)||t&&this.props.resolve&&t.toString()!==this.props.resolve.toString())&&(this.props.lazy||this.fetch())},a.componentWillUnmount=function(){this.abortController.abort()},a.render=function(){var e=this.props,t=e.children,r=e.path,n=e.base,o=e.parentPath,a=this.state,i=a.data,u=a.error,l=a.loading,c=a.response;return e.wait&&null===i&&!u?s.createElement(s.Fragment,null):t(i,{loading:l,error:u},{refetch:this.fetch},{response:c,absolutePath:m(n,o,r)})},o}(s.Component);function q(e){return s.createElement(y,null,(function(t){return s.createElement(v,Object.assign({},t,{parentPath:g(t.parentPath,e.path)}),s.createElement(P,Object.assign({},t,e,{queryParams:p({},t.queryParams,{},e.queryParams),__internal_hasExplicitBase:Boolean(e.base)})))}))}P.defaultProps={base:"",parentPath:"",resolve:function(e){return e},queryParams:{}};var E=function(e){function t(){var t;return(t=e.apply(this,arguments)||this).state={data:null,previousData:null,loading:!t.props.lazy,lastResponse:null,polling:!t.props.lazy,finished:!1,error:null},t.keepPolling=!t.props.lazy,t.abortController=new AbortController,t.signal=t.abortController.signal,t.isModified=function(e,r){return 304!==e.status&&!l(t.state.data,r)},t.getRequestOptions=function(){return"function"==typeof t.props.requestOptions?t.props.requestOptions():t.props.requestOptions||{}},t.isResponseOk=function(e){return e.ok||304===e.status},t.cycle=function(){try{var e=function(e){if(r)return e;var o=t.props,s=o.base,a=o.path,i=o.interval,u=o.wait,l=t.state.lastPollIndex;return Promise.resolve(t.getRequestOptions()).then((function(e){var r=m(s,"",a);Object.keys(t.props.queryParams).length&&(r+="?"+n.stringify(t.props.queryParams));var o=new Request(r,p({},e,{headers:p({Prefer:"wait="+u+"s;"+(l?"index="+l:"")},e.headers)}));return h((function(){return Promise.resolve(fetch(o,{signal:t.signal})).then((function(e){return Promise.resolve(b(e)).then((function(r){var n=r.data,o=r.responseError;if(t.keepPolling&&!t.signal.aborted){if(!t.isResponseOk(e)||o){var s={message:"Failed to poll: "+e.status+" "+e.statusText+(o?" - "+n:""),data:n,status:e.status};t.setState({loading:!1,lastResponse:e,error:s}),!t.props.localErrorOnly&&t.props.onError&&t.props.onError(s,(function(){return Promise.resolve()}),e)}else t.isModified(e,n)&&t.setState((function(t){return{loading:!1,lastResponse:e,previousData:t.data,data:n,error:null,lastPollIndex:e.headers.get("x-polling-index")||void 0}}));return Promise.resolve(new Promise((function(e){return setTimeout(e,i)}))).then((function(){t.cycle()}))}}))}))}),(function(){}))}))},r=!1;if(!t.keepPolling)return Promise.resolve();var o=function(){if(t.props.until&&t.props.until(t.state.data,t.state.lastResponse))return Promise.resolve(t.stop()).then((function(){r=!0}))}();return Promise.resolve(o&&o.then?o.then(e):e(o))}catch(e){return Promise.reject(e)}},t.start=function(){t.keepPolling=!0,t.state.polling||t.setState((function(){return{polling:!0}})),t.cycle()},t.stop=function(){t.keepPolling=!1,t.setState((function(){return{polling:!1,finished:!0}}))},t}f(t,e);var r=t.prototype;return r.componentDidMount=function(){var e=this.props,t=e.lazy;if(void 0===e.path)throw new Error('[restful-react]: You\'re trying to poll something without a path. Please specify a "path" prop on your Poll component.');t||this.start()},r.componentWillUnmount=function(){this.abortController.abort(),this.stop()},r.render=function(){var e=this.state,t=e.lastResponse,r=e.previousData,n=e.data,o=e.polling,s=e.loading,a=e.error,i=e.finished,u=this.props,l=u.children,c=u.resolve,p={response:t,absolutePath:m(u.base,"",u.path)},f={polling:o,loading:s,error:a,finished:i},h={stop:this.stop,start:this.start};return l(t&&c?c(n,r):n,f,h,p)},t}(s.Component);E.defaultProps={interval:1e3,wait:60,base:"",resolve:function(e){return e},queryParams:{}};var O=function(e){function t(){var t;return(t=e.apply(this,arguments)||this).state={loading:!1,error:null},t.abortController=new AbortController,t.signal=t.abortController.signal,t.mutate=function(e,r){try{var o=function(n){function o(n){return Promise.resolve(b(s)).then((function(n){var o=n.data;if(!t.signal.aborted){if(!s.ok||n.responseError){var a={data:o,message:"Failed to fetch: "+s.status+" "+s.statusText,status:s.status};throw t.setState({error:a,loading:!1}),!t.props.localErrorOnly&&t.props.onError&&t.props.onError(a,(function(){return t.mutate(e,r)}),s),a}return t.setState({loading:!1}),t.props.onMutate&&t.props.onMutate(e,o),o}}))}var s,a=new Request(d(),p({method:c,body:v},"function"==typeof f?f():f,{},r,{headers:p({"content-type":"object"==typeof e?"application/json":"text/plain"},"function"==typeof f?n.headers:n,{},r?r.headers:{})})),i=h((function(){return Promise.resolve(fetch(a,{signal:t.signal})).then((function(e){s=e}))}),(function(n){var o={message:"Failed to fetch: "+n.message,data:""};throw t.setState({error:o,loading:!1}),!t.props.localErrorOnly&&t.props.onError&&t.props.onError(o,(function(){return t.mutate(e,r)})),o}));return i&&i.then?i.then(o):o()},s=t.props,a=s.__internal_hasExplicitBase,i=s.base,u=s.parentPath,l=s.path,c=s.verb,f=s.requestOptions;t.setState((function(){return{error:null,loading:!0}}));var d=function(){var r;return r=a?m(i,"","DELETE"===c&&"string"==typeof e?g(l,e):l||""):m(i,u,"DELETE"===c&&"string"==typeof e?g(l,e):l),Object.keys(t.props.queryParams).length&&(r+="?"+n.stringify(t.props.queryParams)),r},v="object"==typeof e?JSON.stringify(e):e;return Promise.resolve("function"==typeof f?Promise.resolve("function"==typeof f?f():(f||{}).headers).then(o):o("function"==typeof f?f():(f||{}).headers))}catch(e){return Promise.reject(e)}},t}f(t,e);var r=t.prototype;return r.componentWillUnmount=function(){this.abortController.abort()},r.render=function(){var e=this.props,t=this.state;return(0,e.children)(this.mutate,{loading:t.loading,error:t.error},{absolutePath:m(e.base,e.parentPath,e.path)})},t}(s.Component);function S(e,t){var r,n;s.useEffect(e,(r=t,n=s.useRef(),c(r,n.current,(function(e,t){if("function"==typeof e&&"function"==typeof t)return e.toString()===t.toString()}))||(n.current=r),n.current))}function j(){try{return new AbortController}catch(e){return}}function x(){var e=s.useRef(j());return{abort:s.useCallback((function(){e&&e.current&&(e.current.abort(),e.current=j())}),[e]),getAbortSignal:function(){var t;return null==e?void 0:null===(t=e.current)||void 0===t?void 0:t.signal}}}O.defaultProps={base:"",parentPath:"",path:"",queryParams:{}};var w=function e(t,r,n,o,s,a){try{var i=function(i){function l(l){var d=a(),y=new Request(C(c,f,p({},o.queryParams,{},m),t.queryParamStringifyOptions||{}),u({},l,i,{signal:d}));return h((function(){return Promise.resolve(fetch(y)).then((function(i){return Promise.resolve(b(i)).then((function(u){var l=u.data,c=u.responseError;if(!d||!d.aborted){if(!i.ok||c){var f={message:"Failed to fetch: "+i.status+" "+i.statusText+(c?" - "+l:""),data:l,status:i.status};return n(p({},r,{loading:!1,error:f})),void(!t.localErrorOnly&&o.onError&&o.onError(f,(function(){return e(t,r,n,o,s,a)}),i))}n(p({},r,{error:null,loading:!1,data:v(l)}))}}))}))}),(function(i){if(!d||!d.aborted){var u={message:"Failed to fetch: "+i.message,data:i.message};n(p({},r,{loading:!1,error:u})),!t.localErrorOnly&&o.onError&&o.onError(u,(function(){return e(t,r,n,o,s,a)}))}}))}return"function"==typeof o.requestOptions?Promise.resolve(o.requestOptions()).then(l):l(o.requestOptions)},l=t.base,c=void 0===l?o.base:l,f=t.path,d=t.resolve,v=void 0===d?function(e){return e}:d,y=t.queryParams,m=void 0===y?{}:y;return r.loading&&s(),!r.error&&r.loading||n(p({},r,{error:null,loading:!0})),Promise.resolve("function"==typeof t.requestOptions?Promise.resolve(t.requestOptions()).then(i):i(t.requestOptions))}catch(e){return Promise.reject(e)}};function C(e,t,r,n){void 0===n&&(n={});var s=e.endsWith("/")?e:e+"/",a=t.startsWith("/")?t.slice(1):t;return i.resolve(s,Object.keys(r).length?a+"?"+o.stringify(r,n):a)}var R=function(e){return"function"==typeof e.cancel&&"function"==typeof e.flush};exports.Get=q,exports.Mutate=function(e){return s.createElement(y,null,(function(t){return s.createElement(v,Object.assign({},t,{parentPath:g(t.parentPath,e.path)}),s.createElement(O,Object.assign({},t,e,{queryParams:p({},t.queryParams,{},e.queryParams),__internal_hasExplicitBase:Boolean(e.base)})))}))},exports.Poll=function(e){return s.createElement(y,null,(function(t){var r="function"==typeof t.requestOptions?t.requestOptions():t.requestOptions||{},n="function"==typeof e.requestOptions?e.requestOptions():e.requestOptions||{};return s.createElement(E,Object.assign({},t,e,{queryParams:p({},t.queryParams,{},e.queryParams),requestOptions:function(){try{return Promise.resolve(r).then((function(e){return Promise.resolve(n).then((function(t){return u(e,t)}))}))}catch(e){return Promise.reject(e)}}}))}))},exports.RestfulProvider=v,exports.default=q,exports.useGet=function(){var e="object"==typeof arguments[0]?arguments[0]:p({},arguments[1],{path:arguments[0]}),r=s.useContext(d),n=s.useCallback("object"==typeof e.debounce?t(w,e.debounce.wait,e.debounce.options):"number"==typeof e.debounce?t(w,e.debounce):e.debounce?t(w):w,[e.debounce]);s.useEffect((function(){return R(n)?function(){return n.cancel()}:void 0}),[n]);var o=s.useState({data:null,response:null,loading:!e.lazy,error:null}),a=o[0],i=o[1],u=x(),l=u.abort,c=u.getAbortSignal;return S((function(){return e.lazy||n(e,a,i,r,l,c),function(){l()}}),[e.lazy,e.path,e.base,e.resolve,e.queryParams,e.requestOptions,l]),p({},a,{absolutePath:C(e.base||r.base,e.path,p({},r.queryParams,{},e.queryParams),e.queryParamStringifyOptions),cancel:function(){i(p({},a,{loading:!1})),l()},refetch:function(t){return void 0===t&&(t={}),n(p({},e,{},t),a,i,r,l,c)}})},exports.useMutate=function(){var e="object"==typeof arguments[0]?arguments[0]:p({},arguments[2],{path:arguments[1],verb:arguments[0]}),t=s.useContext(d),r=e.verb,n=e.base,o=void 0===n?t.base:n,a=e.path,i=e.queryParams,l=void 0===i?{}:i,c=e.resolve,f="DELETE"===r,v=s.useState({error:null,loading:!1}),y=v[0],m=v[1],g=x(),P=g.abort,q=g.getAbortSignal;s.useEffect((function(){return function(){return P()}}),[P]);var E=s.useCallback((function(n,s){try{var i=function(i){function d(d){function v(r){return Promise.resolve(b(g)).then((function(r){var o,s=r.data,a=r.responseError;try{o=c?c(s):s}catch(e){if(P&&P.aborted)return;var i={data:e.message,message:"Failed to resolve: "+e.message};throw m((function(e){return p({},e,{error:i,loading:!1})})),e}if(!P||!P.aborted){if(!g.ok||a){var u={data:o,message:"Failed to fetch: "+g.status+" "+g.statusText,status:g.status};throw m((function(e){return p({},e,{error:u,loading:!1})})),!e.localErrorOnly&&t.onError&&t.onError(u,(function(){return E(n)}),g),u}return m((function(e){return p({},e,{loading:!1})})),e.onMutate&&e.onMutate(n,o),o}}))}var y={method:r,headers:{"content-type":"object"==typeof n?"application/json":"text/plain"}};f||(y.body="object"==typeof n?JSON.stringify(n):n);var g,P=q(),O=new Request(C(o,f?a+"/"+n:a,p({},t.queryParams,{},l),e.queryParamStringifyOptions),u({},d,y,i,s,{signal:P})),S=h((function(){return Promise.resolve(fetch(O)).then((function(e){g=e}))}),(function(r){var o={message:"Failed to fetch: "+r.message,data:""};throw m({error:o,loading:!1}),!e.localErrorOnly&&t.onError&&t.onError(o,(function(){return E(n,s)})),o}));return S&&S.then?S.then(v):v()}return"function"==typeof t.requestOptions?Promise.resolve(t.requestOptions()).then(d):d(t.requestOptions)};return!y.error&&y.loading||m((function(e){return p({},e,{loading:!0,error:null})})),y.loading&&P(),Promise.resolve("function"==typeof e.requestOptions?Promise.resolve(e.requestOptions()).then(i):i(e.requestOptions))}catch(e){return Promise.reject(e)}}),[t.base,t.requestOptions,t.resolve,y.error,y.loading,a,P,q]);return p({},y,{mutate:E,cancel:function(){m((function(e){return p({},e,{loading:!1})})),P()}})};
//# sourceMappingURL=restful-react.cjs.production.min.js.map
